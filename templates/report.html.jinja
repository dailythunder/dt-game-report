<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Daily Thunder Game Report - {{ data.meta.game_id }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      /* Thunder-ish palette */
      --okc-blue: #007ac1;
      --okc-blue-dark: #005a9c;
      --okc-orange: #f25c19;
      --bg: #e4ecf6;
      --card-bg: #ffffff;
      --text-main: #111111;
      --text-muted: #555555;
      --border-subtle: #d0d7e2;
      --win-tint: #e8f5e9;
      --win-border: #66bb6a;
      --standout-gold: #ffd700;
      --standout-silver: #c0c0c0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 16px;
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .matchup-line {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .team-logo img {
      height: 48px;
      width: auto;
      display: block;
    }

    .vs-separator {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-main);
      padding: 0 8px;
    }

    .team-name-with-logo {
      font-size: 28px;
      font-weight: 800;
      color: var(--okc-blue-dark);
    }

    .brand {
      font-size: 14px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--okc-blue-dark);
      font-weight: 600;
    }

    .subtitle {
      font-size: 14px;
      color: var(--text-muted);
    }

    .scoreline {
      text-align: right;
    }

    .scoreline-main {
      font-size: 22px;
      font-weight: 700;
      color: var(--okc-orange);
    }

    .scoreline-teams {
      font-size: 14px;
      color: var(--text-muted);
    }

    .pill-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background-color: #d1e5f8;
      color: var(--okc-blue-dark);
      font-size: 12px;
      font-weight: 600;
      border: 1px solid var(--okc-blue-dark);
    }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--border-subtle);
    }

    .card h2 {
      font-size: 18px;
      margin: 0 0 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card h3 {
      font-size: 16px;
      margin: 16px 0 8px;
    }

    .section-label {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 4px;
      font-weight: 600;
    }

    /* Game Summary Styles */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 8px;
    }

    .summary-box {
      padding: 12px;
      background-color: #f8f9fc;
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
    }

    .summary-box h4 {
      margin: 0 0 8px;
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .summary-box p {
      margin: 4px 0;
      font-size: 14px;
      line-height: 1.5;
    }

    .summary-highlight {
      font-weight: 700;
      color: var(--okc-blue-dark);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      table-layout: fixed;
    }

    /* Sticky headers for better scrolling */
    .player-table-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-top: 4px;
      position: relative;
    }

    table.player-table {
      width: auto;
      min-width: 950px;
      table-layout: auto;
      font-size: 13px;
    }

    table.player-table th,
    table.player-table td {
      white-space: nowrap;
    }

    table.player-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* Runs table styling */
    table.runs-table {
      width: 100%;
      table-layout: auto;
      font-size: 13px;
    }

    table.runs-table th,
    table.runs-table td {
      white-space: nowrap;
    }

    th, td {
      padding: 4px 6px;
      text-align: right;
      border-bottom: 1px solid #e2e6f0;
      white-space: nowrap;
    }

    th:first-child,
    td:first-child {
      text-align: left;
    }

    thead tr {
      background-color: #dbe6f7;
    }

    tbody tr:nth-child(even) {
      background-color: #f7f9fc;
    }

    .team-name-cell {
      font-weight: 600;
    }

    .totals-row {
      font-weight: 700;
      background-color: #e3edff;
    }

    /* Winning team highlighting */
    .winner-row {
      background-color: var(--win-tint) !important;
      border-left: 3px solid var(--win-border);
    }

    /* Highlight PTS column */
    .pts-highlight {
      background-color: #fff3e6;
      font-weight: 700;
      color: var(--okc-orange);
    }

    th.pts-highlight {
      background-color: #ffe0cc;
    }

    /* Standout performance indicators */
    .standout-stat {
      position: relative;
    }

    .standout-stat::after {
      content: "‚≠ê";
      font-size: 10px;
      margin-left: 2px;
      vertical-align: super;
    }

    .double-double::before {
      content: "üî•";
      font-size: 10px;
      margin-right: 2px;
    }

    .leaders-chip {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 999px;
      background-color: #f4f6ff;
      border: 1px solid #d6ddff;
      font-size: 12px;
      margin-right: 6px;
      margin-bottom: 4px;
    }

    .leaders-chip span.label {
      font-weight: 600;
      margin-right: 4px;
      color: var(--okc-blue-dark);
    }

    /* Beautiful leader cards */
    .leaders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .leader-card {
      background: linear-gradient(135deg, #f8f9fc 0%, #ffffff 100%);
      border-radius: 10px;
      padding: 14px;
      border: 2px solid var(--border-subtle);
      transition: all 0.2s ease;
    }

    .leader-card:hover {
      border-color: var(--okc-blue);
      box-shadow: 0 4px 12px rgba(0, 122, 193, 0.15);
      transform: translateY(-2px);
    }

    .leader-stat-name {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .leader-stat-icon {
      font-size: 16px;
    }

    .leader-team-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
      padding: 6px 0;
      border-bottom: 1px solid #e8ecf4;
    }

    .leader-team-row:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .leader-team-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--okc-blue-dark);
    }

    .leader-team-value {
      font-size: 20px;
      font-weight: 800;
      color: var(--okc-orange);
      margin-right: 8px;
    }

    .leader-player-name {
      font-size: 13px;
      color: var(--text-main);
      display: block;
      margin-top: 2px;
    }

    .quarters-wrapper {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .quarter-block {
      background-color: #ffffff;
      border-radius: 10px;
      padding: 10px 12px 14px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      border: 1px solid var(--border-subtle);
    }

    .quarter-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
      gap: 8px;
    }

    .quarter-header-left {
      font-weight: 700;
      font-size: 14px;
      color: var(--okc-blue-dark);
    }

    .quarter-header-right {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Collapsible quarter sections */
    .collapsible-header {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .collapsible-header:hover {
      opacity: 0.8;
    }

    .toggle-icon {
      display: inline-block;
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 7px solid var(--okc-blue-dark);
      transition: transform 0.2s ease;
    }

    .toggle-icon.collapsed {
      transform: rotate(-90deg);
    }

    .collapsible-content {
      max-height: 5000px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .collapsible-content.collapsed {
      max-height: 0;
    }

    .quarter-card {
      margin-top: 8px;
    }

    .quarter-team-label {
      font-weight: 600;
      font-size: 13px;
      margin-top: 6px;
      margin-bottom: 4px;
      color: var(--okc-blue-dark);
    }

    .score-by-quarter-table th,
    .score-by-quarter-table td {
      text-align: center;
    }

    .score-by-quarter-table th:first-child,
    .score-by-quarter-table td:first-child {
      text-align: left;
    }

    /* Column widths for player tables */
    .player-table col.col-player {
      width: 30%;
    }
    .player-table col.col-min {
      width: 8%;
    }
    .player-table col.col-stat {
      width: 6%;
    }

    .downloads-list {
      list-style: none;
      padding-left: 0;
      margin: 4px 0 0;
    }

    .downloads-list li {
      margin-bottom: 4px;
      font-size: 13px;
    }

    .downloads-list a {
      color: var(--okc-blue-dark);
      text-decoration: none;
      border-bottom: 1px dotted var(--okc-blue-dark);
    }

    .downloads-list a:hover {
      color: var(--okc-orange);
      border-bottom-color: var(--okc-orange);
    }

    .empty-state {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-style: italic;
    }

    /* Tablet optimizations */
    @media (max-width: 1024px) and (min-width: 769px) {
      .leaders-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .scoreline {
        text-align: left;
      }

      .matchup-line {
        flex-wrap: wrap;
      }

      .team-logo img {
        height: 36px;
      }

      .team-name-with-logo {
        font-size: 20px;
      }

      .vs-separator {
        font-size: 20px;
      }

      th, td {
        font-size: 11px;
        padding: 3px 4px;
      }

      .summary-grid {
        grid-template-columns: 1fr;
      }

      /* Leaders grid responsive */
      .leaders-grid {
        grid-template-columns: 1fr;
      }

      /* Stack team stats vertically on small screens */
      .team-stats-mobile {
        display: block;
      }

      .team-stats-mobile table {
        margin-bottom: 16px;
      }

      /* Make player tables easier to scroll on mobile */
      .player-table-wrapper {
        border: 1px solid var(--border-subtle);
        border-radius: 6px;
      }
    }

    @media (max-width: 480px) {
      .page {
        padding: 16px 8px 32px;
      }

      .card {
        padding: 12px;
      }

      .matchup-line {
        gap: 6px;
      }

      .team-logo img {
        height: 28px;
      }

      .team-name-with-logo {
        font-size: 18px;
      }

      .vs-separator {
        font-size: 18px;
        padding: 0 4px;
      }
    }

    /* Print styles */
    @media print {
      body {
        background-color: white;
      }

      .page {
        max-width: 100%;
      }

      .card {
        box-shadow: none;
        page-break-inside: avoid;
      }

      .collapsible-content.collapsed {
        max-height: none !important;
      }

      .toggle-icon {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <div class="header-left">
        <div class="brand">Daily Thunder Game Report</div>
        <div class="matchup-line">
          <div class="team-logo">
            <img src="{{ data.teams.home.logo }}" alt="{{ data.teams.home.full_name }} logo">
          </div>
          <span class="team-name-with-logo">{{ data.teams.home.tricode }}</span>
          <span class="vs-separator">vs</span>
          <span class="team-name-with-logo">{{ data.teams.away.tricode }}</span>
          <div class="team-logo">
            <img src="{{ data.teams.away.logo }}" alt="{{ data.teams.away.full_name }} logo">
          </div>
        </div>
        <div class="subtitle">
          {{ data.meta.date }} ¬∑ Game ID {{ data.meta.game_id }}
        </div>
      </div>
      <div class="scoreline">
        <div class="scoreline-main">
          {{ data.teams.home.tricode }} {{ data.meta.final_score_home }}
          &nbsp;‚Äì&nbsp;
          {{ data.meta.final_score_away }} {{ data.teams.away.tricode }}
        </div>
        <div class="scoreline-teams">
          {{ data.teams.home.full_name }} vs {{ data.teams.away.full_name }}
        </div>
      </div>
    </header>

    <div class="pill-row">
      <div class="pill">{{ data.teams.away.full_name }} (Away)</div>
      <div class="pill">{{ data.teams.home.full_name }} (Home)</div>
      <div class="pill">Season {{ data.meta.season }}</div>
    </div>

    <main class="layout">
      <!-- NEW: Game Summary Card -->
      {% set winner_side = "home" if data.meta.final_score_home > data.meta.final_score_away else "away" %}
      {% set loser_side = "away" if winner_side == "home" else "home" %}
      {% set winner = data.teams[winner_side] %}
      {% set loser = data.teams[loser_side] %}
      {% set margin = (data.meta.final_score_home - data.meta.final_score_away)|abs %}
      
      <section class="card">
        <div class="section-label">Game Summary</div>
        <h2>Quick Overview</h2>
        <div class="summary-grid">
          <div class="summary-box">
            <h4>Final Result</h4>
            <p>
              <span class="summary-highlight">{{ winner.full_name }}</span> defeated 
              {{ loser.full_name }} by <span class="summary-highlight">{{ margin }}</span> points
            </p>
            <p style="font-size: 20px; margin-top: 8px; font-weight: 700; color: var(--okc-orange);">
              {{ data.teams.home.tricode }} {{ data.meta.final_score_home }} ‚Äì {{ data.meta.final_score_away }} {{ data.teams.away.tricode }}
            </p>
          </div>

          <div class="summary-box">
            <h4>Leading Scorers</h4>
            {% set home_top = data.leaders.home.points %}
            {% set away_top = data.leaders.away.points %}
            <p>
              <span class="summary-highlight">{{ data.teams.home.tricode }}:</span>
              {{ home_top.players[0] if home_top.players else "N/A" }} ({{ home_top.value }} pts)
            </p>
            <p>
              <span class="summary-highlight">{{ data.teams.away.tricode }}:</span>
              {{ away_top.players[0] if away_top.players else "N/A" }} ({{ away_top.value }} pts)
            </p>
          </div>

          <div class="summary-box">
            <h4>Key Stats</h4>
            {% set home_trad = data.game_totals.traditional.home %}
            {% set away_trad = data.game_totals.traditional.away %}
            <p>
              Largest Lead: 
              <span class="summary-highlight">
                {% if data.largest_lead.home|int > data.largest_lead.away|int %}
                  {{ data.teams.home.tricode }} ({{ data.largest_lead.home }})
                {% else %}
                  {{ data.teams.away.tricode }} ({{ data.largest_lead.away }})
                {% endif %}
              </span>
            </p>
            <p>
              FG%: {{ data.teams.home.tricode }} 
              {% if home_trad.fga %}{{ (home_trad.fg * 100.0 / home_trad.fga)|round(1) }}%{% else %}0%{% endif %}
              vs {{ data.teams.away.tricode }} 
              {% if away_trad.fga %}{{ (away_trad.fg * 100.0 / away_trad.fga)|round(1) }}%{% else %}0%{% endif %}
            </p>
          </div>
        </div>
      </section>

      <!-- Score by quarter + largest lead -->
      <section class="card">
        <div class="section-label">Score Summary</div>
        <h2>
          Score by Quarter
          <span style="font-size: 13px; font-weight: 400; color: var(--text-muted);">
            Largest lead: {{ data.largest_lead.home }} ({{ data.teams.home.tricode }}) /
            {{ data.largest_lead.away }} ({{ data.teams.away.tricode }})
          </span>
        </h2>
        <table class="score-by-quarter-table">
          <thead>
            <tr>
              <th>Team</th>
              {% for q in data.quarters %}
                <th>Q{{ q.number }}</th>
              {% endfor %}
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <!-- Away row first, home row second - with winner highlighting -->
            <tr class="{% if data.meta.final_score_away > data.meta.final_score_home %}winner-row{% endif %}">
              <td class="team-name-cell">{{ data.teams.away.tricode }}</td>
              {% for q in data.quarters %}
                <td>{{ q.away_score }}</td>
              {% endfor %}
              <td>{{ data.meta.final_score_away }}</td>
            </tr>
            <tr class="{% if data.meta.final_score_home > data.meta.final_score_away %}winner-row{% endif %}">
              <td class="team-name-cell">{{ data.teams.home.tricode }}</td>
              {% for q in data.quarters %}
                <td>{{ q.home_score }}</td>
              {% endfor %}
              <td>{{ data.meta.final_score_home }}</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Game flow using runs data - NOW IN TABLE FORMAT -->
      <section class="card">
        <div class="section-label">Game Flow</div>
        <h2>Scoring Runs</h2>

        {% set qr = data.quarters_and_runs %}
        {% set unanswered = qr.unanswered_runs %}
        {% set net_runs = qr.net_runs %}
        {% set highlight = qr.highlight_runs %}

        <div class="quarters-wrapper">
          <!-- 7+ unanswered runs -->
          <div class="quarter-block">
            <div class="quarter-header">
              <div class="quarter-header-left">7+ Unanswered Runs</div>
              <div class="quarter-header-right">
                Based on ESPN play-by-play scoring events.
              </div>
            </div>
            {% if unanswered %}
              <table class="runs-table">
                <thead>
                  <tr>
                    <th>Team</th>
                    <th>Run</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Final Score</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in unanswered %}
                    {% set side = r.side %}
                    {% set team = data.teams[side] %}
                    <tr>
                      <td class="team-name-cell">{{ team.tricode }}</td>
                      <td>{{ r.points }}-0</td>
                      <td>Q{{ r.start_period }} {{ r.start_clock }}</td>
                      <td>Q{{ r.end_period }} {{ r.end_clock }}</td>
                      <td>{{ data.teams.away.tricode }} {{ r.end_away_score }} ‚Äì {{ r.end_home_score }} {{ data.teams.home.tricode }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <div class="empty-state">No 7+ unanswered runs in this game.</div>
            {% endif %}
          </div>

          <!-- 8+ net runs -->
          <div class="quarter-block">
            <div class="quarter-header">
              <div class="quarter-header-left">8+ Net Runs (Scoreboard Margin)</div>
              <div class="quarter-header-right">
                Net swings in margin from a given scoring stretch.
              </div>
            </div>
            {% if net_runs %}
              <table class="runs-table">
                <thead>
                  <tr>
                    <th>Team</th>
                    <th>Net</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Final Score</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in net_runs %}
                    {% set side = r.side %}
                    {% set team = data.teams[side] %}
                    <tr>
                      <td class="team-name-cell">{{ team.tricode }}</td>
                      <td>+{{ r.net_points }}</td>
                      <td>Q{{ r.start_period }} {{ r.start_clock }}</td>
                      <td>Q{{ r.end_period }} {{ r.end_clock }}</td>
                      <td>{{ data.teams.away.tricode }} {{ r.end_away_score }} ‚Äì {{ r.end_home_score }} {{ data.teams.home.tricode }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <div class="empty-state">No 8+ net runs by either team.</div>
            {% endif %}
          </div>

          <!-- Highlight runs -->
          <div class="quarter-block">
            <div class="quarter-header">
              <div class="quarter-header-left">Highlight Runs (‚â•8 pts, opponent ‚â§5)</div>
              <div class="quarter-header-right">
                "Start at each scoring play" logic: best run per start.
              </div>
            </div>
            {% if highlight %}
              <table class="runs-table">
                <thead>
                  <tr>
                    <th>Team</th>
                    <th>Run</th>
                    <th>Net</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Final Score</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in highlight %}
                    {% set side = r.side %}
                    {% set team = data.teams[side] %}
                    <tr>
                      <td class="team-name-cell">{{ team.tricode }}</td>
                      <td>{{ r.points_for }}‚Äì{{ r.points_against }}</td>
                      <td>+{{ r.net_points }}</td>
                      <td>Q{{ r.start_period }} {{ r.start_clock }}</td>
                      <td>Q{{ r.end_period }} {{ r.end_clock }}</td>
                      <td>{{ data.teams.away.tricode }} {{ r.end_away_score }} ‚Äì {{ r.end_home_score }} {{ data.teams.home.tricode }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <div class="empty-state">No highlight runs meeting the thresholds.</div>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- Team traditional totals + misc scoring - PTS FIRST WITH SEPARATE % COLUMNS -->
      <section class="card">
        <div class="section-label">Team Stats</div>
        <h2>Full Game ‚Äì Traditional Team Totals</h2>
        {% set home_trad = data.game_totals.traditional.home %}
        {% set away_trad = data.game_totals.traditional.away %}
        {% set misc = data.game_totals.misc if data.game_totals.misc is defined else {} %}
        {% set misc_home = misc.home if misc.home is defined else {} %}
        {% set misc_away = misc.away if misc.away is defined else {} %}

        <table>
          <thead>
            <tr>
              <th>Team</th>
              <th>FG</th>
              <th>FG%</th>
              <th>3P</th>
              <th>3P%</th>
              <th>FT</th>
              <th>FT%</th>
              <th>REB</th>
              <th>OREB</th>
              <th>DREB</th>
              <th>AST</th>
              <th>STL</th>
              <th>BLK</th>
              <th>TOV</th>
              <th>PF</th>
            </tr>
          </thead>
          <tbody>
            <!-- Away first, home second - with winner highlighting -->
            <tr class="{% if data.meta.final_score_away > data.meta.final_score_home %}winner-row{% endif %}">
              <td class="team-name-cell">{{ data.teams.away.tricode }}</td>
              <td>{{ away_trad.fg }}/{{ away_trad.fga }}</td>
              <td>{% if away_trad.fga %}{{ (away_trad.fg * 100.0 / away_trad.fga)|round(1) }}%{% endif %}</td>
              <td>{{ away_trad.fg3 }}/{{ away_trad.fg3a }}</td>
              <td>{% if away_trad.fg3a %}{{ (away_trad.fg3 * 100.0 / away_trad.fg3a)|round(1) }}%{% endif %}</td>
              <td>{{ away_trad.ft }}/{{ away_trad.fta }}</td>
              <td>{% if away_trad.fta %}{{ (away_trad.ft * 100.0 / away_trad.fta)|round(1) }}%{% endif %}</td>
              <td>{{ away_trad.trb }}</td>
              <td>{{ away_trad.orb }}</td>
              <td>{{ away_trad.drb }}</td>
              <td>{{ away_trad.ast }}</td>
              <td>{{ away_trad.stl }}</td>
              <td>{{ away_trad.blk }}</td>
              <td>{{ away_trad.tov }}</td>
              <td>{{ away_trad.pf }}</td>
            </tr>
            <tr class="{% if data.meta.final_score_home > data.meta.final_score_away %}winner-row{% endif %}">
              <td class="team-name-cell">{{ data.teams.home.tricode }}</td>
              <td>{{ home_trad.fg }}/{{ home_trad.fga }}</td>
              <td>{% if home_trad.fga %}{{ (home_trad.fg * 100.0 / home_trad.fga)|round(1) }}%{% endif %}</td>
              <td>{{ home_trad.fg3 }}/{{ home_trad.fg3a }}</td>
              <td>{% if home_trad.fg3a %}{{ (home_trad.fg3 * 100.0 / home_trad.fg3a)|round(1) }}%{% endif %}</td>
              <td>{{ home_trad.ft }}/{{ home_trad.fta }}</td>
              <td>{% if home_trad.fta %}{{ (home_trad.ft * 100.0 / home_trad.fta)|round(1) }}%{% endif %}</td>
              <td>{{ home_trad.trb }}</td>
              <td>{{ home_trad.orb }}</td>
              <td>{{ home_trad.drb }}</td>
              <td>{{ home_trad.ast }}</td>
              <td>{{ home_trad.stl }}</td>
              <td>{{ home_trad.blk }}</td>
              <td>{{ home_trad.tov }}</td>
              <td>{{ home_trad.pf }}</td>
            </tr>
          </tbody>
        </table>

        <h3>Team Misc Stats</h3>
        <table>
          <thead>
            <tr>
              <th>Team</th>
              <th>Points in the Paint</th>
              <th>Points off Turnovers</th>
              <th>Fast Break Points</th>
            </tr>
          </thead>
          <tbody>
            <tr class="{% if data.meta.final_score_away > data.meta.final_score_home %}winner-row{% endif %}">
              <td class="team-name-cell">{{ data.teams.away.tricode }}</td>
              <td>{{ misc_away.pitp if misc_away.pitp is defined else 0 }}</td>
              <td>{{ misc_away.points_off_to if misc_away.points_off_to is defined else 0 }}</td>
              <td>{{ misc_away.fast_break if misc_away.fast_break is defined else 0 }}</td>
            </tr>
            <tr class="{% if data.meta.final_score_home > data.meta.final_score_away %}winner-row{% endif %}">
              <td class="team-name-cell">{{ data.teams.home.tricode }}</td>
              <td>{{ misc_home.pitp if misc_home.pitp is defined else 0 }}</td>
              <td>{{ misc_home.points_off_to if misc_home.points_off_to is defined else 0 }}</td>
              <td>{{ misc_home.fast_break if misc_home.fast_break is defined else 0 }}</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Leaders - BEAUTIFUL CARD LAYOUT -->
      <section class="card">
        <div class="section-label">Leaders</div>
        <h2>Team Leaders ‚Äì Traditional</h2>

        <div class="leaders-grid">
          <!-- Points Card -->
          <div class="leader-card">
            <div class="leader-stat-name">
              <span class="leader-stat-icon">üèÄ</span>
              Points
            </div>
            {% set away_leaders = data.leaders.away %}
            {% set home_leaders = data.leaders.home %}
            <div class="leader-team-row">
              <div>
                <div class="leader-team-name">{{ data.teams.away.tricode }}</div>
                <span class="leader-player-name">{{ away_leaders.points.players[0] if away_leaders.points.players else "N/A" }}</span>
              </div>
              <span class="leader-team-value">{{ away_leaders.points.value }}</span>
            </div>
            <div class="leader-team-row">
              <div>
                <div class="leader-team-name">{{ data.teams.home.tricode }}</div>
                <span class="leader-player-name">{{ home_leaders.points.players[0] if home_leaders.points.players else "N/A" }}</span>
              </div>
              <span class="leader-team-value">{{ home_leaders.points.value }}</span>
            </div>
          </div>

          <!-- Rebounds Card -->
          <div class="leader-card">
            <div class="leader-stat-name">
              <span class="leader-stat-icon">üí™</span>
              Rebounds
            </div>
            <div class="leader-team-row">
              <div>
                <div class="leader-team-name">{{ data.teams.away.tricode }}</div>
                <span class="leader-player-name">{{ (away_leaders.rebounds.rebounds if away_leaders.rebounds.rebounds is defined else away_leaders.rebounds.players)[0] if (away_leaders.rebounds.rebounds if away_leaders.rebounds.rebounds is defined else away_leaders.rebounds.players) else "N/A" }}</span>
              </div>
              <span class="leader-team-value">{{ away_leaders.rebounds.value }}</span>
            </div>
            <div class="leader-team-row">
              <div>
                <div class="leader-team-name">{{ data.teams.home.tricode }}</div>
                <span class="leader-player-name">{{ (home_leaders.rebounds.rebounds if home_leaders.rebounds.rebounds is defined else home_leaders.rebounds.players)[0] if (home_leaders.rebounds.rebounds if home_leaders.rebounds.rebounds is defined else home_leaders.rebounds.players) else "N/A" }}</span>
              </div>
              <span class="leader-team-value">{{ home_leaders.rebounds.value }}</span>
            </div>
          </div>

          <!-- Assists Card -->
          <div class="leader-card">
            <div class="leader-stat-name">
              <span class="leader-stat-icon">ü§ù</span>
              Assists
            </div>
            <div class="leader-team-row">
              <div>
                <div class="leader-team-name">{{ data.teams.away.tricode }}</div>
                <span class="leader-player-name">{{ away_leaders.assists.players[0] if away_leaders.assists.players else "N/A" }}</span>
              </div>
              <span class="leader-team-value">{{ away_leaders.assists.value }}</span>
            </div>
            <div class="leader-team-row">
              <div>
                <div class="leader-team-name">{{ data.teams.home.tricode }}</div>
                <span class="leader-player-name">{{ home_leaders.assists.players[0] if home_leaders.assists.players else "N/A" }}</span>
              </div>
              <span class="leader-team-value">{{ home_leaders.assists.value }}</span>
            </div>
          </div>

          <!-- Steals Card -->
          <div class="leader-card">
            <div class="leader-stat-name">
              <span class="leader-stat-icon">üëê</span>
              Steals
            </div>
            <div class="leader-team-row">
              <div>
                <div class="leader-team-name">{{ data.teams.away.tricode }}</div>
                <span class="leader-player-name">{{ away_leaders.steals.players[0] if away_leaders.steals.players else "N/A" }}</span>
              </div>
              <span class="leader-team-value">{{ away_leaders.steals.value }}</span>
            </div>
            <div class="leader-team-row">
              <div>
                <div class="leader-team-name">{{ data.teams.home.tricode }}</div>
                <span class="leader-player-name">{{ home_leaders.steals.players[0] if home_leaders.steals.players else "N/A" }}</span>
              </div>
              <span class="leader-team-value">{{ home_leaders.steals.value }}</span>
            </div>
          </div>

          <!-- Blocks Card -->
          <div class="leader-card">
            <div class="leader-stat-name">
              <span class="leader-stat-icon">üö´</span>
              Blocks
            </div>
            <div class="leader-team-row">
              <div>
                <div class="leader-team-name">{{ data.teams.away.tricode }}</div>
                <span class="leader-player-name">{{ away_leaders.blocks.players[0] if away_leaders.blocks.players else "N/A" }}</span>
              </div>
              <span class="leader-team-value">{{ away_leaders.blocks.value }}</span>
            </div>
            <div class="leader-team-row">
              <div>
                <div class="leader-team-name">{{ data.teams.home.tricode }}</div>
                <span class="leader-player-name">{{ home_leaders.blocks.players[0] if home_leaders.blocks.players else "N/A" }}</span>
              </div>
              <span class="leader-team-value">{{ home_leaders.blocks.value }}</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Full game player box scores (traditional only) - PTS FIRST WITH STANDOUT INDICATORS -->
      <section class="card">
        <div class="section-label">Full Game Box Score</div>
        <h2>Traditional ‚Äì Players</h2>

        {% for side in ["away", "home"] %}
          {% set team = data.teams[side] %}
          {% set players = data.players[side] %}
          <h3>{{ team.full_name }} ({{ team.tricode }})</h3>
          <div class="player-table-wrapper">
            <table class="player-table">
            <colgroup>
              <col class="col-player">
              <col class="col-min">
              <col class="col-stat">
              <col class="col-stat">
              <col class="col-stat">
              <col class="col-stat">
              <col class="col-stat">
              <col class="col-stat">
              <col class="col-stat">
              <col class="col-stat">
              <col class="col-stat">
              <col class="col-stat">
              <col class="col-stat">
              <col class="col-stat">
              <col class="col-stat">
              <col class="col-stat">
            </colgroup>
            <thead>
              <tr>
                <th>Player</th>
                <th>MIN</th>
                <th class="pts-highlight">PTS</th>
                <th>FG</th>
                <th>FG%</th>
                <th>3P</th>
                <th>3P%</th>
                <th>FT</th>
                <th>FT%</th>
                <th>REB</th>
                <th>OREB</th>
                <th>DREB</th>
                <th>AST</th>
                <th>STL</th>
                <th>BLK</th>
                <th>TOV</th>
                <th>PF</th>
              </tr>
            </thead>
            <tbody>
              {% set team_totals = {
                "min": "",
                "fg": 0,
                "fga": 0,
                "fg3": 0,
                "fg3a": 0,
                "ft": 0,
                "fta": 0,
                "trb": 0,
                "orb": 0,
                "drb": 0,
                "ast": 0,
                "stl": 0,
                "blk": 0,
                "tov": 0,
                "pf": 0,
                "pts": 0
              } %}

              {% for p in players %}
                {% set stats = p.traditional if p.traditional is defined and p.traditional is mapping else p %}
                {% set has_double_double = (
                  (stats.pts >= 10 and stats.trb >= 10) or
                  (stats.pts >= 10 and stats.ast >= 10) or
                  (stats.trb >= 10 and stats.ast >= 10) or
                  (stats.pts >= 10 and stats.stl >= 10) or
                  (stats.pts >= 10 and stats.blk >= 10)
                ) %}
                <tr>
                  <td class="team-name-cell {% if has_double_double %}double-double{% endif %}">{{ p.name }}</td>
                  <td>{{ p.min }}</td>
                  <td class="pts-highlight {% if stats.pts >= 20 %}standout-stat{% endif %}">{{ stats.pts }}</td>
                  <td>{{ stats.fg }}/{{ stats.fga }}</td>
                  <td>{% if stats.fga %}{{ (stats.fg * 100.0 / stats.fga)|round(1) }}%{% endif %}</td>
                  <td>{{ stats.fg3 }}/{{ stats.fg3a }}</td>
                  <td>{% if stats.fg3a %}{{ (stats.fg3 * 100.0 / stats.fg3a)|round(1) }}%{% endif %}</td>
                  <td>{{ stats.ft }}/{{ stats.fta }}</td>
                  <td>{% if stats.fta %}{{ (stats.ft * 100.0 / stats.fta)|round(1) }}%{% endif %}</td>
                  <td {% if stats.trb >= 10 %}class="standout-stat"{% endif %}>{{ stats.trb }}</td>
                  <td>{{ stats.orb }}</td>
                  <td>{{ stats.drb }}</td>
                  <td {% if stats.ast >= 10 %}class="standout-stat"{% endif %}>{{ stats.ast }}</td>
                  <td>{{ stats.stl }}</td>
                  <td>{{ stats.blk }}</td>
                  <td>{{ stats.tov }}</td>
                  <td>{{ stats.pf }}</td>
                </tr>
                {% set _ = team_totals.update({
                  "fg": team_totals.fg + (stats.fg or 0),
                  "fga": team_totals.fga + (stats.fga or 0),
                  "fg3": team_totals.fg3 + (stats.fg3 or 0),
                  "fg3a": team_totals.fg3a + (stats.fg3a or 0),
                  "ft": team_totals.ft + (stats.ft or 0),
                  "fta": team_totals.fta + (stats.fta or 0),
                  "trb": team_totals.trb + (stats.trb or 0),
                  "orb": team_totals.orb + (stats.orb or 0),
                  "drb": team_totals.drb + (stats.drb or 0),
                  "ast": team_totals.ast + (stats.ast or 0),
                  "stl": team_totals.stl + (stats.stl or 0),
                  "blk": team_totals.blk + (stats.blk or 0),
                  "tov": team_totals.tov + (stats.tov or 0),
                  "pf": team_totals.pf + (stats.pf or 0),
                  "pts": team_totals.pts + (stats.pts or 0)
                }) %}
              {% endfor %}

              <tr class="totals-row">
                <td class="team-name-cell">Team Totals</td>
                <td></td>
                <td class="pts-highlight">{{ team_totals.pts }}</td>
                <td>{{ team_totals.fg }}/{{ team_totals.fga }}</td>
                <td>{% if team_totals.fga %}{{ (team_totals.fg * 100.0 / team_totals.fga)|round(1) }}%{% endif %}</td>
                <td>{{ team_totals.fg3 }}/{{ team_totals.fg3a }}</td>
                <td>{% if team_totals.fg3a %}{{ (team_totals.fg3 * 100.0 / team_totals.fg3a)|round(1) }}%{% endif %}</td>
                <td>{{ team_totals.ft }}/{{ team_totals.fta }}</td>
                <td>{% if team_totals.fta %}{{ (team_totals.ft * 100.0 / team_totals.fta)|round(1) }}%{% endif %}</td>
                <td>{{ team_totals.trb }}</td>
                <td>{{ team_totals.orb }}</td>
                <td>{{ team_totals.drb }}</td>
                <td>{{ team_totals.ast }}</td>
                <td>{{ team_totals.stl }}</td>
                <td>{{ team_totals.blk }}</td>
                <td>{{ team_totals.tov }}</td>
                <td>{{ team_totals.pf }}</td>
              </tr>
            </tbody>
          </table>
          </div>
        {% endfor %}
      </section>

      <!-- Quarter-by-quarter traditional (team + players) - COLLAPSIBLE QUARTERS -->
      <section class="card">
        <div class="section-label">Quarter by Quarter</div>
        <h2>Traditional ‚Äì Team & Players (by quarter)</h2>

        {% set qr = data.quarters_and_runs %}
        {% set q_team_totals = qr.quarter_team_totals %}
        {% set q_player_totals = qr.quarter_player_totals %}

        <div class="quarters-wrapper">
          {% set quarter_keys = q_team_totals.keys() | list | sort %}
          {% for q_key in quarter_keys %}
            {% set qnum = q_key|int %}
            {% set q_team = q_team_totals[q_key] %}
            {% set q_players = q_player_totals[q_key] if q_player_totals[q_key] is defined else {} %}

            <div class="quarter-block">
              <div class="quarter-header collapsible-header" onclick="toggleQuarter('q{{ qnum }}')">
                <span class="toggle-icon" id="toggle-q{{ qnum }}"></span>
                <div class="quarter-header-left">Quarter {{ qnum }}</div>
                <div class="quarter-header-right">
                  Score: {{ data.teams.away.tricode }} {{ q_team.away.pts }} ‚Äì {{ q_team.home.pts }} {{ data.teams.home.tricode }}
                </div>
              </div>

              <div class="collapsible-content" id="content-q{{ qnum }}">
                {% for side in ["away", "home"] %}
                  {% set team = data.teams[side] %}
                  {% set tt = q_team[side] %}

                  <div class="quarter-card">
                    <div class="quarter-team-label">
                      {{ team.full_name }} ({{ team.tricode }}) ‚Äì Players (Q{{ qnum }})
                    </div>
                    <div class="player-table-wrapper">
                      <table class="player-table">
                      <colgroup>
                        <col class="col-player">
                        <col class="col-stat">
                        <col class="col-stat">
                        <col class="col-stat">
                        <col class="col-stat">
                        <col class="col-stat">
                        <col class="col-stat">
                        <col class="col-stat">
                        <col class="col-stat">
                        <col class="col-stat">
                        <col class="col-stat">
                        <col class="col-stat">
                        <col class="col-stat">
                        <col class="col-stat">
                      </colgroup>
                      <thead>
                        <tr>
                          <th>Player</th>
                          <th class="pts-highlight">PTS</th>
                          <th>FG</th>
                          <th>FG%</th>
                          <th>3P</th>
                          <th>3P%</th>
                          <th>FT</th>
                          <th>FT%</th>
                          <th>REB</th>
                          <th>OREB</th>
                          <th>DREB</th>
                          <th>AST</th>
                          <th>STL</th>
                          <th>BLK</th>
                          <th>TOV</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for pid, p in q_players.items() if p.side == side %}
                          <tr>
                            <td class="team-name-cell">{{ p.name }}</td>
                            <td class="pts-highlight {% if p.pts >= 10 %}standout-stat{% endif %}">{{ p.pts }}</td>
                            <td>{{ p.fgm }}/{{ p.fga }}</td>
                            <td>{% if p.fga %}{{ (p.fgm * 100.0 / p.fga)|round(1) }}%{% endif %}</td>
                            <td>{{ p.tpm }}/{{ p.tpa }}</td>
                            <td>{% if p.tpa %}{{ (p.tpm * 100.0 / p.tpa)|round(1) }}%{% endif %}</td>
                            <td>{{ p.ftm }}/{{ p.fta }}</td>
                            <td>{% if p.fta %}{{ (p.ftm * 100.0 / p.fta)|round(1) }}%{% endif %}</td>
                            <td>{{ p.reb }}</td>
                            <td>{{ p.oreb }}</td>
                            <td>{{ p.dreb }}</td>
                            <td>{{ p.ast }}</td>
                            <td>{{ p.stl }}</td>
                            <td>{{ p.blk }}</td>
                            <td>{{ p.tov }}</td>
                          </tr>
                        {% endfor %}

                        <tr class="totals-row">
                          <td class="team-name-cell">Team Totals</td>
                          <td class="pts-highlight">{{ tt.pts }}</td>
                          <td>{{ tt.fgm }}/{{ tt.fga }}</td>
                          <td>{% if tt.fga %}{{ (tt.fgm * 100.0 / tt.fga)|round(1) }}%{% endif %}</td>
                          <td>{{ tt.tpm }}/{{ tt.tpa }}</td>
                          <td>{% if tt.tpa %}{{ (tt.tpm * 100.0 / tt.tpa)|round(1) }}%{% endif %}</td>
                          <td>{{ tt.ftm }}/{{ tt.fta }}</td>
                          <td>{% if tt.fta %}{{ (tt.ftm * 100.0 / tt.fta)|round(1) }}%{% endif %}</td>
                          <td>{{ tt.reb }}</td>
                          <td>{{ tt.oreb }}</td>
                          <td>{{ tt.dreb }}</td>
                          <td>{{ tt.ast }}</td>
                          <td>{{ tt.stl }}</td>
                          <td>{{ tt.blk }}</td>
                          <td>{{ tt.tov }}</td>
                        </tr>
                      </tbody>
                    </table>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      </section>


      {% if data.files %}
      <!-- Downloads section -->
      <section class="card">
        <div class="section-label">Downloads</div>
        <h2>Play-by-Play & Data Files</h2>
        <p style="font-size: 13px; color: var(--text-muted); margin-top: 0;">
          Links below assume the underlying CSV / JSON / other files are deployed alongside this report.
        </p>
        <ul class="downloads-list">
          {% for key, path in data.files.items() %}
            <li>
              <a href="{{ path }}">{{ key|replace("_", " ")|title }}</a>
            </li>
          {% endfor %}
        </ul>
      </section>
      {% endif %}
    </main>
  </div>

  <script>
    // Toggle quarter-by-quarter sections
    function toggleQuarter(quarterId) {
      const content = document.getElementById('content-' + quarterId);
      const toggle = document.getElementById('toggle-' + quarterId);
      
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        toggle.classList.remove('collapsed');
      } else {
        content.classList.add('collapsed');
        toggle.classList.add('collapsed');
      }
    }

    // Collapse all quarters by default on mobile
    if (window.innerWidth <= 768) {
      document.addEventListener('DOMContentLoaded', function() {
        const quarters = document.querySelectorAll('[id^="content-q"]');
        quarters.forEach(q => q.classList.add('collapsed'));
        
        const toggles = document.querySelectorAll('[id^="toggle-q"]');
        toggles.forEach(t => t.classList.add('collapsed'));
      });
    }
  </script>
</body>
</html>
